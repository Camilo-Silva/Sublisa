<header class="header">
  <div class="header-container">
    <div class="logo">
      <a routerLink="/" (click)="cerrarMenu()">
        <img src="/images/LOGOSUBLISA.png" alt="Sublisa Logo" class="logo-image">
      </a>
    </div>

    <!-- Buscador Mobile -->
    <div class="search-container search-mobile" [class.active]="searchActivo()">
      @if (!searchActivo()) {
        <button class="search-icon-btn" (click)="activarBusqueda()" aria-label="Buscar">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
      } @else {
        <div class="search-box">
          <input
            type="text"
            class="search-input-header"
            placeholder="Buscar productos..."
            [(ngModel)]="searchQuery"
            (ngModelChange)="onSearchInput($event)"
            (keydown)="onSearchKeydown($event)"
            autocomplete="off"
          />
          <button class="search-close-btn" (click)="cerrarBusqueda()" aria-label="Cerrar b√∫squeda">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>

          @if (mostrarSugerencias() && sugerencias().length > 0) {
            <div class="search-suggestions">
              @for (producto of sugerencias(); track producto.id; let i = $index) {
                <button
                  type="button"
                  class="suggestion-item"
                  [class.selected]="selectedSuggestionIndex() === i"
                  (click)="irAProducto(producto.id, $event)"
                  (mouseenter)="selectedSuggestionIndex.set(i)">
                  <div class="suggestion-image">
                    @if (producto.imagenes && producto.imagenes.length > 0) {
                      <img [src]="producto.imagenes[0].url" [alt]="producto.nombre" />
                    } @else {
                      <div class="no-image">üì¶</div>
                    }
                  </div>
                  <div class="suggestion-info">
                    <span class="suggestion-name">{{ producto.nombre }}</span>
                    <span class="suggestion-price">${{ producto.precio.toLocaleString('es-AR') }}</span>
                  </div>
                </button>
              }
              <button type="button" class="suggestion-view-all" (click)="onSearchEnter()">
                Ver todos los resultados ‚Üí
              </button>
            </div>
          }

          @if (loadingSearch()) {
            <div class="search-loading">
              <span>Buscando...</span>
            </div>
          }
        </div>
      }
    </div>

    <button (click)="carritoService.abrirCarrito()" class="carrito-mobile">
      üõí
      @if (carritoService.cantidadTotal() > 0) {
        <span class="badge-mobile">{{ carritoService.cantidadTotal() }}</span>
      }
    </button>

    <button class="menu-toggle" (click)="toggleMenu()" [class.active]="menuAbierto">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <!-- Nav Desktop: hover lateral -->
    <nav class="nav nav-desktop">
      <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" (click)="cerrarMenu()" class="nav-link">
        Inicio
      </a>

      <div class="nav-item-dropdown"
           (mouseenter)="menuProductosAbierto.set(true)"
           (mouseleave)="cerrarMenuProductos()">
        <a routerLink="/productos"
           routerLinkActive="active"
           (click)="toggleMenuProductos(); $event.preventDefault()"
           class="nav-link productos-link">
          Productos ‚ñæ
        </a>
        <div class="dropdown-menu" [class.show]="menuProductosAbierto()">
          @for (categoria of categorias(); track categoria.nombre) {
            <div class="dropdown-item-with-submenu"
                 (mouseenter)="onCategoriaHover(categoria.nombre)"
                 (mouseleave)="onCategoriaHover(null)">
              <a [routerLink]="['/productos']"
                 [queryParams]="{categoria: categoria.nombre}"
                 (click)="cerrarMenu()"
                 class="dropdown-item">
                <span>{{ categoria.nombre }}</span>
                @if (categoria.subcategorias && categoria.subcategorias.length > 0) {
                  <span class="arrow">‚Üí</span>
                }
              </a>

              <!-- Submenu lateral desktop -->
              @if (categoriaHover() === categoria.nombre && categoria.subcategorias && categoria.subcategorias.length > 0) {
                <div class="dropdown-submenu">
                  @for (subcategoria of categoria.subcategorias; track subcategoria.nombre) {
                    <a [routerLink]="['/productos']"
                       [queryParams]="{categoria: categoria.nombre, subcategoria: subcategoria.nombre}"
                       (click)="cerrarMenu()"
                       class="dropdown-subitem">
                      {{ subcategoria.nombre }}
                    </a>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>

      <a routerLink="/quienes-somos" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link">
        Qui√©nes Somos
      </a>

      <a routerLink="/como-comprar" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link">
        C√≥mo Comprar
      </a>

      <!-- Buscador Desktop -->
      <div class="search-container" [class.active]="searchActivo()">
        @if (!searchActivo()) {
          <button class="search-icon-btn" (click)="activarBusqueda()" aria-label="Buscar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
        } @else {
          <div class="search-box">
            <input
              type="text"
              class="search-input-header"
              placeholder="Buscar productos..."
              [(ngModel)]="searchQuery"
              (ngModelChange)="onSearchInput($event)"
              (keydown)="onSearchKeydown($event)"
              autocomplete="off"
            />
            <button class="search-close-btn" (click)="cerrarBusqueda()" aria-label="Cerrar b√∫squeda">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>

            @if (mostrarSugerencias() && sugerencias().length > 0) {
              <div class="search-suggestions">
                @for (producto of sugerencias(); track producto.id; let i = $index) {
                  <button
                    type="button"
                    class="suggestion-item"
                    [class.selected]="selectedSuggestionIndex() === i"
                    (click)="irAProducto(producto.id, $event)"
                    (mouseenter)="selectedSuggestionIndex.set(i)">
                    <div class="suggestion-image">
                      @if (producto.imagenes && producto.imagenes.length > 0) {
                        <img [src]="producto.imagenes[0].url" [alt]="producto.nombre" />
                      } @else {
                        <div class="no-image">üì¶</div>
                      }
                    </div>
                    <div class="suggestion-info">
                      <span class="suggestion-name">{{ producto.nombre }}</span>
                      <span class="suggestion-price">${{ producto.precio.toLocaleString('es-AR') }}</span>
                    </div>
                  </button>
                }
                <button type="button" class="suggestion-view-all" (click)="onSearchEnter()">
                  Ver todos los resultados ‚Üí
                </button>
              </div>
            }

            @if (loadingSearch()) {
              <div class="search-loading">
                <span>Buscando...</span>
              </div>
            }
          </div>
        }
      </div>

      <button (click)="carritoService.toggleCarrito(); cerrarMenu()" class="nav-link carrito-link carrito-btn">
        üõí Carrito
        @if (carritoService.cantidadTotal() > 0) {
          <span class="badge">{{ carritoService.cantidadTotal() }}</span>
        }
      </button>

      @if (authService.isAuthenticatedSignal$()()) {
        @if (authService.isAdmin()) {
          <a routerLink="/admin/dashboard" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link admin-link">
            üîê Admin
          </a>
        } @else {
          <a routerLink="/mi-cuenta" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link cuenta-link">
            üë§ Mi Cuenta
          </a>
        }
        <button (click)="logout()" class="nav-link logout-btn">
          üö™ Cerrar Sesi√≥n
        </button>
      } @else {
        <a routerLink="/login" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link login-link">
          üîë Iniciar Sesi√≥n
        </a>
      }
    </nav>

    <!-- Nav Mobile: expansi√≥n vertical -->
    <nav class="nav nav-mobile" [class.open]="menuAbierto">
      <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" (click)="cerrarMenu()" class="nav-link">
        Inicio
      </a>

      <!-- Men√∫ Productos que agrupa categor√≠as -->
      <div class="mobile-productos-wrapper">
        <button (click)="toggleProductosMobile($event)"
                class="mobile-productos"
                [class.expandida]="menuProductosMovilAbierto()">
          Productos
          <span class="chevron">‚ñº</span>
        </button>

        <!-- Categor√≠as expandibles dentro de Productos -->
        <div class="mobile-categorias-container" [class.show]="menuProductosMovilAbierto()">
          @for (categoria of categorias(); track categoria.nombre) {
            <div class="mobile-categoria-item">
              <a [routerLink]="['/productos']"
                 [queryParams]="{categoria: categoria.nombre}"
                 (click)="categoria.subcategorias && categoria.subcategorias.length > 0 ? toggleCategoriaMobile(categoria.nombre, $event) : cerrarMenu()"
                 class="mobile-categoria"
                 [class.expandida]="categoriaExpandidaMobile() === categoria.nombre">
                {{ categoria.nombre }}
                @if (categoria.subcategorias && categoria.subcategorias.length > 0) {
                  <span class="chevron">‚ñº</span>
                }
              </a>

              <!-- Subcategor√≠as debajo de la categor√≠a -->
              @if (categoria.subcategorias && categoria.subcategorias.length > 0) {
                <div class="mobile-subcategorias" [class.show]="categoriaExpandidaMobile() === categoria.nombre">
                  <!-- Ver todo -->
                  <a [routerLink]="['/productos']"
                     [queryParams]="{categoria: categoria.nombre}"
                     (click)="cerrarMenu()"
                     class="mobile-subcategoria ver-todo">
                    Ver toda {{ categoria.nombre }}
                  </a>
                  <!-- Subcategor√≠as -->
                  @for (subcategoria of categoria.subcategorias; track subcategoria.nombre) {
                    <a [routerLink]="['/productos']"
                       [queryParams]="{categoria: categoria.nombre, subcategoria: subcategoria.nombre}"
                       (click)="cerrarMenu()"
                       class="mobile-subcategoria">
                      {{ subcategoria.nombre }}
                    </a>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>      <a routerLink="/quienes-somos" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link">
        Qui√©nes Somos
      </a>

      <a routerLink="/como-comprar" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link">
        C√≥mo Comprar
      </a>

      <button (click)="carritoService.toggleCarrito(); cerrarMenu()" class="nav-link carrito-link carrito-btn">
        üõí Carrito
        @if (carritoService.cantidadTotal() > 0) {
          <span class="badge">{{ carritoService.cantidadTotal() }}</span>
        }
      </button>

      <!-- Mostrar seg√∫n estado de autenticaci√≥n y rol -->
      @if (authService.isAuthenticatedSignal$()()) {
        @if (authService.isAdmin()) {
          <a routerLink="/admin/dashboard" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link admin-link">
            üîê Admin
          </a>
        } @else {
          <a routerLink="/mi-cuenta" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link cuenta-link">
            üë§ Mi Cuenta
          </a>
        }
        <button (click)="logout()" class="nav-link logout-btn">
          üö™ Cerrar Sesi√≥n
        </button>
      } @else {
        <a routerLink="/login" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link login-link">
          üîë Iniciar Sesi√≥n
        </a>
      }
    </nav>
  </div>
</header>
