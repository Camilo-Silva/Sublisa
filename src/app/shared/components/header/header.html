<header class="header">
  <div class="header-container">
    <div class="logo">
      <a routerLink="/" (click)="cerrarMenu()">
        <img src="/images/LOGOSUBLISA.png" alt="Sublisa Logo" class="logo-image">
      </a>
    </div>

    <!-- Buscador Mobile -->
    <div class="search-container search-mobile" [class.active]="searchActivo()">
      @if (!searchActivo()) {
        <button class="search-icon-btn" (click)="activarBusqueda()" aria-label="Buscar">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
      } @else {
        <div class="search-box">
          <input
            type="text"
            class="search-input-header"
            placeholder="Buscar productos..."
            [(ngModel)]="searchQuery"
            (ngModelChange)="onSearchInput($event)"
            (keydown)="onSearchKeydown($event)"
            autocomplete="off"
          />
          <button class="search-close-btn" (click)="cerrarBusqueda()" aria-label="Cerrar búsqueda">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>

          @if (mostrarSugerencias() && sugerencias().length > 0) {
            <div class="search-suggestions">
              @for (producto of sugerencias(); track producto.id; let i = $index) {
                <button
                  type="button"
                  class="suggestion-item"
                  [class.selected]="selectedSuggestionIndex() === i"
                  (click)="irAProducto(producto.id, $event)"
                  (mouseenter)="selectedSuggestionIndex.set(i)">
                  <div class="suggestion-image">
                    @if (producto.imagenes && producto.imagenes.length > 0) {
                      <img [src]="producto.imagenes[0].url" [alt]="producto.nombre" />
                    } @else {
                      <div class="no-image">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                          <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                          <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                      </div>
                    }
                  </div>
                  <div class="suggestion-info">
                    <span class="suggestion-name">{{ producto.nombre }}</span>
                    <span class="suggestion-price">${{ producto.precio.toLocaleString('es-AR') }}</span>
                  </div>
                </button>
              }
              <button type="button" class="suggestion-view-all" (click)="onSearchEnter()">
                Ver todos los resultados →
              </button>
            </div>
          }

          @if (loadingSearch()) {
            <div class="search-loading">
              <span>Buscando...</span>
            </div>
          }
        </div>
      }
    </div>

    <button (click)="carritoService.abrirCarrito()" class="carrito-mobile">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
      </svg>
      @if (carritoService.cantidadTotal() > 0) {
        <span class="badge-mobile">{{ carritoService.cantidadTotal() }}</span>
      }
    </button>

    <button class="menu-toggle" (click)="toggleMenu()" [class.active]="menuAbierto">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <!-- Nav Desktop: hover lateral -->
    <nav class="nav nav-desktop">
      <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" (click)="cerrarMenu()" class="nav-link">
        Inicio
      </a>

      <div class="nav-item-dropdown"
           (mouseenter)="menuProductosAbierto.set(true)"
           (mouseleave)="cerrarMenuProductos()">
        <a routerLink="/productos"
           routerLinkActive="active"
           (click)="toggleMenuProductos(); $event.preventDefault()"
           class="nav-link productos-link">
          Productos ▾
        </a>
        <div class="dropdown-menu" [class.show]="menuProductosAbierto()">
          @for (categoria of categorias(); track categoria.nombre) {
            <div class="dropdown-item-with-submenu"
                 (mouseenter)="onCategoriaHover(categoria.nombre)"
                 (mouseleave)="onCategoriaHover(null)">
              <a [routerLink]="['/productos']"
                 [queryParams]="{categoria: categoria.nombre}"
                 (click)="cerrarMenu()"
                 class="dropdown-item">
                <span>{{ categoria.nombre }}</span>
                @if (categoria.subcategorias && categoria.subcategorias.length > 0) {
                  <span class="arrow">→</span>
                }
              </a>

              <!-- Submenu lateral desktop -->
              @if (categoriaHover() === categoria.nombre && categoria.subcategorias && categoria.subcategorias.length > 0) {
                <div class="dropdown-submenu">
                  @for (subcategoria of categoria.subcategorias; track subcategoria.nombre) {
                    <a [routerLink]="['/productos']"
                       [queryParams]="{categoria: categoria.nombre, subcategoria: subcategoria.nombre}"
                       (click)="cerrarMenu()"
                       class="dropdown-subitem">
                      {{ subcategoria.nombre }}
                    </a>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>

      <a routerLink="/quienes-somos" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link">
        Quiénes Somos
      </a>

      <a routerLink="/como-comprar" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link">
        Cómo Comprar
      </a>

      <!-- Buscador Desktop -->
      <div class="search-container" [class.active]="searchActivo()">
        @if (!searchActivo()) {
          <button class="search-icon-btn" (click)="activarBusqueda()" aria-label="Buscar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
        } @else {
          <div class="search-box">
            <input
              type="text"
              class="search-input-header"
              placeholder="Buscar productos..."
              [(ngModel)]="searchQuery"
              (ngModelChange)="onSearchInput($event)"
              (keydown)="onSearchKeydown($event)"
              autocomplete="off"
            />
            <button class="search-close-btn" (click)="cerrarBusqueda()" aria-label="Cerrar búsqueda">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>

            @if (mostrarSugerencias() && sugerencias().length > 0) {
              <div class="search-suggestions">
                @for (producto of sugerencias(); track producto.id; let i = $index) {
                  <button
                    type="button"
                    class="suggestion-item"
                    [class.selected]="selectedSuggestionIndex() === i"
                    (click)="irAProducto(producto.id, $event)"
                    (mouseenter)="selectedSuggestionIndex.set(i)">
                    <div class="suggestion-image">
                      @if (producto.imagenes && producto.imagenes.length > 0) {
                        <img [src]="producto.imagenes[0].url" [alt]="producto.nombre" />
                      } @else {
                        <div class="no-image">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                          </svg>
                        </div>
                      }
                    </div>
                    <div class="suggestion-info">
                      <span class="suggestion-name">{{ producto.nombre }}</span>
                      <span class="suggestion-price">${{ producto.precio.toLocaleString('es-AR') }}</span>
                    </div>
                  </button>
                }
                <button type="button" class="suggestion-view-all" (click)="onSearchEnter()">
                  Ver todos los resultados →
                </button>
              </div>
            }

            @if (loadingSearch()) {
              <div class="search-loading">
                <span>Buscando...</span>
              </div>
            }
          </div>
        }
      </div>

      <button (click)="carritoService.toggleCarrito(); cerrarMenu()" class="nav-link carrito-link carrito-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        Carrito
        @if (carritoService.cantidadTotal() > 0) {
          <span class="badge">{{ carritoService.cantidadTotal() }}</span>
        }
      </button>

      @if (authService.isAuthenticatedSignal$()()) {
        @if (authService.isAdmin()) {
          <a routerLink="/admin/dashboard" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link admin-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Admin
          </a>
        } @else {
          <a routerLink="/mi-cuenta" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link cuenta-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          Mi Cuenta
        </a>
        }
        <button (click)="logout()" class="nav-link logout-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Cerrar Sesión
        </button>
      } @else {
        <a routerLink="/login" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link login-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
          Iniciar Sesión
        </a>
      }
    </nav>

    <!-- Nav Mobile: expansión vertical -->
    <nav class="nav nav-mobile" [class.open]="menuAbierto">
      <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" (click)="cerrarMenu()" class="nav-link">
        Inicio
      </a>

      <!-- Menú Productos que agrupa categorías -->
      <div class="mobile-productos-wrapper">
        <button (click)="toggleProductosMobile($event)"
                class="mobile-productos"
                [class.expandida]="menuProductosMovilAbierto()">
          Productos
          <span class="chevron">▼</span>
        </button>

        <!-- Categorías expandibles dentro de Productos -->
        <div class="mobile-categorias-container" [class.show]="menuProductosMovilAbierto()">
          @for (categoria of categorias(); track categoria.nombre) {
            <div class="mobile-categoria-item">
              <a [routerLink]="['/productos']"
                 [queryParams]="{categoria: categoria.nombre}"
                 (click)="categoria.subcategorias && categoria.subcategorias.length > 0 ? toggleCategoriaMobile(categoria.nombre, $event) : cerrarMenu()"
                 class="mobile-categoria"
                 [class.expandida]="categoriaExpandidaMobile() === categoria.nombre">
                {{ categoria.nombre }}
                @if (categoria.subcategorias && categoria.subcategorias.length > 0) {
                  <span class="chevron">▼</span>
                }
              </a>

              <!-- Subcategorías debajo de la categoría -->
              @if (categoria.subcategorias && categoria.subcategorias.length > 0) {
                <div class="mobile-subcategorias" [class.show]="categoriaExpandidaMobile() === categoria.nombre">
                  <!-- Ver todo -->
                  <a [routerLink]="['/productos']"
                     [queryParams]="{categoria: categoria.nombre}"
                     (click)="cerrarMenu()"
                     class="mobile-subcategoria ver-todo">
                    Ver toda {{ categoria.nombre }}
                  </a>
                  <!-- Subcategorías -->
                  @for (subcategoria of categoria.subcategorias; track subcategoria.nombre) {
                    <a [routerLink]="['/productos']"
                       [queryParams]="{categoria: categoria.nombre, subcategoria: subcategoria.nombre}"
                       (click)="cerrarMenu()"
                       class="mobile-subcategoria">
                      {{ subcategoria.nombre }}
                    </a>
                  }
                </div>
              }
            </div>
          }
        </div>
      </div>      <a routerLink="/quienes-somos" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link">
        Quiénes Somos
      </a>

      <a routerLink="/como-comprar" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link">
        Cómo Comprar
      </a>

      <button (click)="carritoService.toggleCarrito(); cerrarMenu()" class="nav-link carrito-link carrito-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        Carrito
        @if (carritoService.cantidadTotal() > 0) {
          <span class="badge">{{ carritoService.cantidadTotal() }}</span>
        }
      </button>

      <!-- Mostrar según estado de autenticación y rol -->
      @if (authService.isAuthenticatedSignal$()()) {
        @if (authService.isAdmin()) {
          <a routerLink="/admin/dashboard" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link admin-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Admin
          </a>
        } @else {
          <a routerLink="/mi-cuenta" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link cuenta-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Mi Cuenta
          </a>
        }
        <button (click)="logout()" class="nav-link logout-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Cerrar Sesión
        </button>
      } @else {
        <a routerLink="/login" routerLinkActive="active" (click)="cerrarMenu()" class="nav-link login-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
          Iniciar Sesión
        </a>
      }
    </nav>
  </div>
</header>
