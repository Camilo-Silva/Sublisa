<div class="mi-cuenta-container">
  <div class="page-header">
    <h1>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      Mi Cuenta
    </h1>
    <button (click)="logout()" class="btn-logout">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
      Cerrar Sesión
    </button>
  </div>

  @if (loading()) {
    <div class="loading-state">
      <p>Cargando información...</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <p>{{ error() }}</p>
      <button (click)="cargarDatos()" class="btn-retry">Reintentar</button>
    </div>
  } @else {
    <!-- Información Personal -->
    <div class="section-card">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        Información Personal
      </h2>
      @if (userProfile()) {
        <div class="info-grid">
          <div class="info-item">
            <label>Nombre Completo</label>
            <p>{{ userProfile()!.nombre }} {{ userProfile()!.apellido }}</p>
          </div>
          <div class="info-item">
            <label>Email</label>
            <p>{{ authService.getCurrentUser()?.email }}</p>
          </div>
          @if (userProfile()!.telefono) {
            <div class="info-item">
              <label>Teléfono / WhatsApp</label>
              <p>{{ userProfile()!.telefono }}</p>
            </div>
          }
        </div>
      }
    </div>

    <!-- Historial de Pedidos -->
    <div class="section-card">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
          <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        Mis Últimos Pedidos
      </h2>

      @if (pedidos().length === 0) {
        <div class="empty-pedidos">
          <p>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            Aún no has realizado ningún pedido
          </p>
          <a routerLink="/" class="btn-ir-catalogo">
            Ver Productos
          </a>
        </div>
      } @else {
        <div class="pedidos-table-container">
          <table class="pedidos-table">
            <thead>
              <tr>
                <th>Número</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (pedido of pedidos(); track pedido.id) {
                <tr>
                  <td class="pedido-numero">#{{ pedido.numero_pedido }}</td>
                  <td>
                    <div class="pedido-fecha">
                      <strong>{{ pedido.created_at | date:'dd/MM/yyyy' }}</strong>
                      <small>{{ pedido.created_at | date:'HH:mm' }}</small>
                    </div>
                  </td>
                  <td class="pedido-total">
                    ${{ pedido.total | number:'1.2-2' }}
                  </td>
                  <td>
                    <span
                      class="estado-badge"
                      [ngClass]="getEstadoClass(pedido.estado)"
                    >
                      {{ getEstadoTexto(pedido.estado) }}
                    </span>
                  </td>
                  <td class="pedido-acciones">
                    <button
                      (click)="verDetallePedido(pedido)"
                      class="btn-ver-detalle"
                      [disabled]="loadingDetalle()"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                      Ver
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="pedidos-resumen">
          <p><strong>Total de pedidos:</strong> {{ pedidos().length }}</p>
        </div>
      }
    </div>

    <!-- Ayuda -->
    <div class="section-card help-section">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        ¿Necesitas Ayuda?
      </h2>
      <p>Si tienes alguna consulta sobre tus pedidos, contáctanos:</p>
      <div class="contact-buttons">
        <a [href]="getWhatsAppUrl()" target="_blank" class="btn-contact">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
          </svg>
          WhatsApp
        </a>
        <a [href]="'mailto:' + email()" class="btn-contact">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
          Email
        </a>
      </div>
    </div>
  }

  <!-- Modal de Detalle del Pedido -->
  @if (mostrarModal()) {
    <div class="modal-overlay" (click)="cerrarModal()" tabindex="0">
      <div class="modal-content" (click)="$event.stopPropagation()" tabindex="0">
        <div class="modal-header">
          <h2>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            Detalle del Pedido #{{ pedidoSeleccionado()?.numero_pedido }}
          </h2>
          <button class="btn-close-modal" (click)="cerrarModal()">✕</button>
        </div>

        @if (pedidoSeleccionado()) {
          <div class="modal-body">
            <!-- Info del pedido -->
            <div class="pedido-info-summary">
              <div class="info-row">
                <span class="label">Fecha:</span>
                <span>{{ pedidoSeleccionado()!.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="info-row">
                <span class="label">Estado:</span>
                <span
                  class="estado-badge"
                  [ngClass]="getEstadoClass(pedidoSeleccionado()!.estado)"
                >
                  {{ getEstadoTexto(pedidoSeleccionado()!.estado) }}
                </span>
              </div>
            </div>

            <!-- Productos del Pedido -->
            <div class="productos-pedido">
              <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                  <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
                Productos del Pedido
              </h3>

              <table class="detalle-table">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unit.</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  @for (detalle of pedidoSeleccionado()!.detalles; track detalle.id) {
                    <tr>
                      <td>
                        <div class="producto-info">
                          <strong>{{ detalle.producto.nombre }}</strong>
                          <small>SKU: {{ detalle.producto.sku }}</small>
                        </div>
                      </td>
                      <td class="text-center">{{ detalle.cantidad }}</td>
                      <td>${{ detalle.precio_unitario | number:'1.2-2' }}</td>
                      <td class="subtotal">${{ detalle.subtotal | number:'1.2-2' }}</td>
                    </tr>
                  }
                </tbody>
              </table>

              <div class="pedido-total">
                <span class="total-label">Total:</span>
                <span class="total-monto">${{ pedidoSeleccionado()!.total | number:'1.2-2' }}</span>
              </div>
            </div>

            @if (pedidoSeleccionado()!.notas) {
              <div class="pedido-notas">
                <h4>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                  Notas del pedido:
                </h4>
                <p>{{ pedidoSeleccionado()!.notas }}</p>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>

