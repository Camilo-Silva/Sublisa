<div class="mi-cuenta-container">
  <div class="page-header">
    <h1>üë§ Mi Cuenta</h1>
    <button (click)="cerrarSesion()" class="btn-logout">
      üö™ Cerrar Sesi√≥n
    </button>
  </div>

  @if (loading()) {
    <div class="loading-state">
      <p>Cargando informaci√≥n...</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <p>{{ error() }}</p>
      <button (click)="cargarDatos()" class="btn-retry">Reintentar</button>
    </div>
  } @else {
    <!-- Informaci√≥n Personal -->
    <div class="section-card">
      <h2>üìã Informaci√≥n Personal</h2>
      @if (userProfile()) {
        <div class="info-grid">
          <div class="info-item">
            <label>Nombre Completo</label>
            <p>{{ userProfile()!.nombre }} {{ userProfile()!.apellido }}</p>
          </div>
          <div class="info-item">
            <label>Email</label>
            <p>{{ authService.getCurrentUser()?.email }}</p>
          </div>
          @if (userProfile()!.telefono) {
            <div class="info-item">
              <label>Tel√©fono / WhatsApp</label>
              <p>{{ userProfile()!.telefono }}</p>
            </div>
          }
        </div>
      }
    </div>

    <!-- Historial de Pedidos -->
    <div class="section-card">
      <h2>üì¶ Mis √öltimos Pedidos</h2>

      @if (pedidos().length === 0) {
        <div class="empty-pedidos">
          <p>üõçÔ∏è A√∫n no has realizado ning√∫n pedido</p>
          <a routerLink="/" class="btn-ir-catalogo">
            Ver Productos
          </a>
        </div>
      } @else {
        <div class="pedidos-table-container">
          <table class="pedidos-table">
            <thead>
              <tr>
                <th>N√∫mero</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (pedido of pedidos(); track pedido.id) {
                <tr>
                  <td class="pedido-numero">#{{ pedido.numero_pedido }}</td>
                  <td>
                    <div class="pedido-fecha">
                      <strong>{{ pedido.created_at | date:'dd/MM/yyyy' }}</strong>
                      <small>{{ pedido.created_at | date:'HH:mm' }}</small>
                    </div>
                  </td>
                  <td class="pedido-total">
                    ${{ pedido.total | number:'1.2-2' }}
                  </td>
                  <td>
                    <span
                      class="estado-badge"
                      [ngClass]="getEstadoClass(pedido.estado)"
                    >
                      {{ getEstadoTexto(pedido.estado) }}
                    </span>
                  </td>
                  <td class="pedido-acciones">
                    <button
                      (click)="verDetallePedido(pedido)"
                      class="btn-ver-detalle"
                      [disabled]="loadingDetalle()"
                    >
                      üëÅÔ∏è Ver
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <div class="pedidos-resumen">
          <p><strong>Total de pedidos:</strong> {{ pedidos().length }}</p>
        </div>
      }
    </div>

    <!-- Ayuda -->
    <div class="section-card help-section">
      <h2>‚ùì ¬øNecesitas Ayuda?</h2>
      <p>Si tienes alguna consulta sobre tus pedidos, cont√°ctanos:</p>
      <div class="contact-buttons">
        <a [href]="getWhatsAppUrl()" target="_blank" class="btn-contact">
          üí¨ WhatsApp
        </a>
        <a [href]="'mailto:' + email()" class="btn-contact">
          ‚úâÔ∏è Email
        </a>
      </div>
    </div>
  }

  <!-- Modal de Detalle del Pedido -->
  @if (mostrarModal()) {
    <div class="modal-overlay" (click)="cerrarModal()" tabindex="0">
      <div class="modal-content" (click)="$event.stopPropagation()" tabindex="0">
        <div class="modal-header">
          <h2>üì¶ Detalle del Pedido #{{ pedidoSeleccionado()?.numero_pedido }}</h2>
          <button class="btn-close-modal" (click)="cerrarModal()">‚úï</button>
        </div>

        @if (pedidoSeleccionado()) {
          <div class="modal-body">
            <!-- Info del pedido -->
            <div class="pedido-info-summary">
              <div class="info-row">
                <span class="label">Fecha:</span>
                <span>{{ pedidoSeleccionado()!.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="info-row">
                <span class="label">Estado:</span>
                <span
                  class="estado-badge"
                  [ngClass]="getEstadoClass(pedidoSeleccionado()!.estado)"
                >
                  {{ getEstadoTexto(pedidoSeleccionado()!.estado) }}
                </span>
              </div>
            </div>

            <!-- Productos del Pedido -->
            <div class="productos-pedido">
              <h3>üìã Productos del Pedido</h3>

              <table class="detalle-table">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unit.</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  @for (detalle of pedidoSeleccionado()!.detalles; track detalle.id) {
                    <tr>
                      <td>
                        <div class="producto-info">
                          <strong>{{ detalle.producto.nombre }}</strong>
                          <small>SKU: {{ detalle.producto.sku }}</small>
                        </div>
                      </td>
                      <td class="text-center">{{ detalle.cantidad }}</td>
                      <td>${{ detalle.precio_unitario | number:'1.2-2' }}</td>
                      <td class="subtotal">${{ detalle.subtotal | number:'1.2-2' }}</td>
                    </tr>
                  }
                </tbody>
              </table>

              <div class="pedido-total">
                <span class="total-label">Total:</span>
                <span class="total-monto">${{ pedidoSeleccionado()!.total | number:'1.2-2' }}</span>
              </div>
            </div>

            @if (pedidoSeleccionado()!.notas) {
              <div class="pedido-notas">
                <h4>üìù Notas del pedido:</h4>
                <p>{{ pedidoSeleccionado()!.notas }}</p>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>
