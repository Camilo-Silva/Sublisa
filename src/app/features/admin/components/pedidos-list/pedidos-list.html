<div class="pedidos-list-container">
  <div class="page-header">
    <div>
      <h1>
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
          <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
        </svg>
        Gestión de Pedidos
      </h1>
      <p>Administra y consulta todos los pedidos</p>
    </div>
    <a routerLink="/admin/dashboard" class="btn-volver">
      ← Volver al Dashboard
    </a>
  </div>

  <!-- Filtros -->
  <div class="filtros-section">
    <h2>
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      Filtros de Búsqueda
    </h2>

    <div class="filtros-grid">
      <div class="filtro-item">
        <label for="busqueda">Buscar</label>
        <input
          type="text"
          id="busqueda"
          placeholder="Número de pedido, cliente, teléfono..."
          [(ngModel)]="busqueda"
          (input)="aplicarFiltros()"
        />
      </div>

      <div class="filtro-item">
        <label for="estado">Estado</label>
        <select
          id="estado"
          [(ngModel)]="estadoFiltro"
          (change)="aplicarFiltros()"
        >
          @for (estado of estados; track estado) {
            <option [value]="estado">{{ getEstadoTexto(estado) }}</option>
          }
        </select>
      </div>

      <div class="filtro-item">
        <label for="fechaDesde">Fecha Desde</label>
        <input
          type="date"
          id="fechaDesde"
          [(ngModel)]="fechaDesde"
          (change)="aplicarFiltros()"
        />
      </div>

      <div class="filtro-item">
        <label for="fechaHasta">Fecha Hasta</label>
        <input
          type="date"
          id="fechaHasta"
          [(ngModel)]="fechaHasta"
          (change)="aplicarFiltros()"
        />
      </div>

      <div class="filtro-item filtro-actions">
        <button (click)="limpiarFiltros()" class="btn-limpiar">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
          Limpiar Filtros
        </button>
        <button (click)="exportarAExcel()" class="btn-exportar" title="Exportar resumen de pedidos">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Exportar Excel
        </button>
        <button (click)="exportarAExcelDetallado()" class="btn-exportar-detallado" title="Exportar informe detallado con totales">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
          Exportar Detallado
        </button>
        <button (click)="exportarClientes()" class="btn-exportar-clientes" title="Exportar listado de clientes con datos de registro">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          Exportar Clientes
        </button>
      </div>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-state">
      <p>Cargando pedidos...</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
        {{ error() }}
      </p>
      <button (click)="cargarPedidos()" class="btn-retry">Reintentar</button>
    </div>
  } @else if (pedidosFiltrados().length === 0) {
    <div class="empty-state">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
          <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        No se encontraron pedidos con los filtros aplicados
      </p>
      <button (click)="limpiarFiltros()" class="btn-limpiar-filtros">
        Limpiar filtros
      </button>
    </div>
  } @else {
    <!-- Resumen -->
    <div class="resumen-pedidos">
      <div class="resumen-item">
        <span class="resumen-label">Total Pedidos:</span>
        <span class="resumen-valor">{{ pedidosFiltrados().length }}</span>
      </div>
      <div class="resumen-item">
        <span class="resumen-label">Monto Total:</span>
        <span class="resumen-valor resumen-monto">${{ getTotalPedidos() | number:'1.2-2' }}</span>
      </div>
    </div>

    <!-- Info de paginación -->
    <div class="resultados-info">
      <p>
        Mostrando {{ (paginaActual() - 1) * itemsPorPagina() + 1 }} -
        {{ Math.min(paginaActual() * itemsPorPagina(), pedidosFiltrados().length) }}
        de {{ pedidosFiltrados().length }} pedidos
      </p>
    </div>

    <!-- Tabla de pedidos -->
    <div class="pedidos-table-container">
      <table class="pedidos-table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Contacto</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          @for (pedido of pedidosPaginados(); track pedido.id) {
            <tr>
              <td class="pedido-numero">#{{ pedido.numero_pedido }}</td>
              <td>
                <div class="pedido-fecha">
                  <strong>{{ pedido.created_at | date:'dd/MM/yyyy' }}</strong>
                  <small>{{ pedido.created_at | date:'HH:mm' }}</small>
                </div>
              </td>
              <td>
                <strong>{{ pedido.cliente?.nombre || 'N/A' }}</strong>
              </td>
              <td>
                <div class="contacto-info">
                  @if (pedido.cliente?.telefono) {
                    <span>
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                      </svg>
                      {{ pedido.cliente?.telefono }}
                    </span>
                  }
                  @if (pedido.cliente?.email) {
                    <small>{{ pedido.cliente?.email }}</small>
                  }
                </div>
              </td>
              <td class="pedido-total">
                ${{ pedido.total | number:'1.2-2' }}
              </td>
              <td>
                <span
                  class="estado-badge"
                  [ngClass]="getEstadoClass(pedido.estado)"
                >
                  {{ getEstadoTexto(pedido.estado) }}
                </span>
              </td>
              <td>
                @if (pedido.id) {
                  <button
                    (click)="verDetalle(pedido.id)"
                    class="btn-ver-detalle"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Ver
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Controles de paginación -->
    @if (totalPaginas() > 1) {
      <div class="paginacion-container">
        <button
          class="btn-paginacion"
          [disabled]="paginaActual() === 1"
          (click)="paginaAnterior()"
        >
          ← Anterior
        </button>

        <div class="paginas-numeros">
          @for (pagina of getPaginasVisibles(); track $index) {
            @if (pagina === -1) {
              <span class="pagina-separador">...</span>
            } @else {
              <button
                class="btn-pagina"
                [class.active]="pagina === paginaActual()"
                (click)="irAPagina(pagina)"
              >
                {{ pagina }}
              </button>
            }
          }
        </div>

        <button
          class="btn-paginacion"
          [disabled]="paginaActual() === totalPaginas()"
          (click)="paginaSiguiente()"
        >
          Siguiente →
        </button>
      </div>
    }
  }
</div>
