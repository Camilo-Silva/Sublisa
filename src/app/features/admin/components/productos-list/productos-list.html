<div class="productos-list-container">
  <div class="page-header">
    <div>
      <h1>
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
          <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        Gestión de Productos
      </h1>
      <p>Administra el catálogo de productos</p>
    </div>
    <a routerLink="/admin/productos/nuevo" class="btn-nuevo">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Nuevo Producto
    </a>
  </div>

  <div class="toolbar">
    <div class="search-box">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input
        type="text"
        placeholder="Buscar por nombre, SKU, categoría..."
        [(ngModel)]="busqueda"
        (input)="filtrarProductos()"
      />
    </div>
    <a routerLink="/admin/dashboard" class="btn-volver">
      ← Volver al Dashboard
    </a>
  </div>

  @if (loading()) {
    <div class="loading-state">
      <p>Cargando productos...</p>
    </div>
  } @else if (error()) {
    <div class="error-state">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
        {{ error() }}
      </p>
      <button (click)="cargarProductos()" class="btn-retry">Reintentar</button>
    </div>
  } @else if (productosFiltrados().length === 0) {
    <div class="empty-state">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
          <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        No hay productos registrados
      </p>
      <a routerLink="/admin/productos/nuevo" class="btn-crear-primero">
        Crear primer producto
      </a>
    </div>
  } @else {
    <div class="productos-table-container">
      <table class="productos-table">
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>SKU</th>
            <th>Categoría</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (producto of productosFiltrados(); track producto.id) {
            <tr>
              <td>
                <div class="producto-imagen">
                  @if (producto.imagenes && producto.imagenes.length > 0) {
                    <img
                      [src]="producto.imagenes[0].url"
                      [alt]="producto.nombre"
                    />
                  } @else {
                    <div class="sin-imagen">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                      </svg>
                    </div>
                  }
                </div>
              </td>
              <td>
                <div class="producto-info">
                  <strong>{{ producto.nombre }}</strong>
                  @if (producto.descripcion) {
                    <small>{{ producto.descripcion | slice:0:50 }}{{ producto.descripcion.length > 50 ? '...' : '' }}</small>
                  }
                </div>
              </td>
              <td>
                <span class="sku">{{ producto.sku || '-' }}</span>
              </td>
              <td>
                @if (producto.categoria) {
                  <span class="categoria-badge">{{ producto.categoria }}</span>
                } @else {
                  <span class="texto-muted">Sin categoría</span>
                }
              </td>
              <td class="precio">
                ${{ producto.precio | number:'1.2-2' }}
              </td>
              <td>
                <span
                  class="stock-badge"
                  [ngClass]="getStockClass(producto.stock)"
                >
                  {{ producto.stock }}
                </span>
              </td>
              <td>
                <div class="acciones">
                  <button
                    (click)="editarProducto(producto.id)"
                    class="btn-editar"
                    title="Editar"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                  <button
                    (click)="confirmarEliminar(producto)"
                    class="btn-eliminar"
                    title="Eliminar"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="resumen">
      <p>Mostrando {{ productosFiltrados().length }} de {{ productos().length }} productos</p>
    </div>
  }

  <!-- Modal de confirmación -->
  @if (productoAEliminar()) {
    <div class="modal-overlay" (click)="cancelarEliminar()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Confirmar Eliminación
          </h2>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas eliminar el producto <strong>{{ productoAEliminar()!.nombre }}</strong>?</p>
          <p class="warning-text">Esta acción no se puede deshacer y también eliminará todas las imágenes asociadas.</p>
        </div>
        <div class="modal-footer">
          <button (click)="cancelarEliminar()" class="btn-cancelar">
            Cancelar
          </button>
          <button (click)="eliminarProducto()" class="btn-confirmar-eliminar">
            Eliminar Producto
          </button>
        </div>
      </div>
    </div>
  }
</div>
